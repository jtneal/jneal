version: 2.1

############################################################
# Shared Jobs and Configuration
############################################################

executors:
  node-executor:
    docker:
      - image: 'circleci/node:12-browsers'

commands:
  attach-workspace-step:
    steps:
      - attach_workspace:
          at: '.'
  persist-workspace-step:
    steps:
      - persist_to_workspace:
          root: '.'
          paths:
            - '.'

############################################################
# Workflow
############################################################

workflows:
  version: 2.1
  pipeline:
    jobs:
      - build
      - static-analysis:
          requires:
            - build
      - unit-tests:
          requires:
            - build
      - e2e-tests:
          requires:
            - build

############################################################
# Jobs
############################################################

jobs:

  build:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - 'v1-npm-deps-{{ checksum "package-lock.json" }}'
            - 'v1-npm-deps-'
      - run:
          name: 'Install NPM Dependencies'
          command: 'npm install'
      - save_cache:
          key: 'v1-npm-deps-{{ checksum "package-lock.json" }}'
          paths:
            - 'node_modules'
      - persist-workspace-step

  static-analysis:
    executor: node-executor
    steps:
      - attach-workspace-step
      - run:
          name: 'Run Static Analysis'
          command: 'npm run lint'

  unit-tests:
    executor: node-executor
    steps:
      - attach-workspace-step
      - run:
          name: 'Run Unit Tests'
          command: 'npm run test:once'
      - store_test_results:
          path: './test-results'
      - persist-workspace-step

  e2e-tests:
    executor: node-executor
    steps:
      - attach-workspace-step
      - run:
          name: 'Run E2E Tests'
          command: 'npm run e2e:once'
      - store_test_results:
          path: './test-results'

  sonar-scanner:
    docker:
      - image: 'newtmitch/sonar-scanner:4-alpine'
        entrypoint: 'bash'
    steps:
      - attach-workspace-step
      - run:
          name: 'Run & Report Coverage'
          command: |
            sonar-scanner \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=$SONAR_TOKEN \
              -Dsonar.organization=jtneal \
              -Dsonar.projectKey=jtneal_jneal \
              -Dsonar.projectName=jneal \
              -Dsonar.projectVersion=$CIRCLE_SHA1 \
              -Dsonar.branch.name=$CIRCLE_BRANCH
